<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug TeamCity - Donn√©es Brutes</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00ff88;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .debug-section {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #00ff88;
        }
        
        .debug-title {
            color: #00ff88;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .data-display {
            background-color: #1a1a1a;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: #3d3d3d;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 14px;
            color: #cccccc;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            color: #00ff88;
            font-size: 18px;
        }
        
        .error {
            color: #ff4444;
            background-color: #3d1a1a;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .success {
            color: #44ff44;
            background-color: #1a3d1a;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug TeamCity - Donn√©es Brutes</h1>
        
        <div class="debug-section">
            <div class="debug-title">üìä Statistiques Globales</div>
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-builds">-</div>
                    <div class="stat-label">Total Builds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-projects">-</div>
                    <div class="stat-label">Projets Uniques</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-buildtypes">-</div>
                    <div class="stat-label">BuildTypes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="response-time">-</div>
                    <div class="stat-label">Temps R√©ponse (ms)</div>
                </div>
            </div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">üîÑ Donn√©es Brutes - /api/builds/tree</div>
            <div id="loading-tree" class="loading">Chargement des donn√©es d'arborescence...</div>
            <div id="tree-data" class="data-display" style="display: none;"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">üìã Liste Tous les Builds</div>
            <div id="loading-builds" class="loading">Chargement de tous les builds...</div>
            <div id="builds-list" class="data-display" style="display: none;"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">üèóÔ∏è Projets et Sous-projets</div>
            <div id="loading-projects" class="loading">Analyse des projets...</div>
            <div id="projects-structure" class="data-display" style="display: none;"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-title">üîç Logs Backend (Console)</div>
            <div class="data-display" id="backend-logs">
                Les logs du backend appara√Ætront ici quand tu recharges la page...
            </div>
        </div>
    </div>

    <script>
        console.log('=== DEBUG PAGE LOADED ===');
        
        // Fonction pour formater JSON de mani√®re lisible
        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }
        
        // Fonction pour afficher les statistiques
        function updateStats(data) {
            const totalBuilds = data.total_builds || 0;
            const projects = data.projects || {};
            const projectNames = Object.keys(projects);
            
            // Compter tous les buildTypes dans l'arborescence
            let totalBuildTypes = 0;
            function countBuildTypes(node) {
                if (node.builds) {
                    totalBuildTypes += node.builds.length;
                }
                if (node.subprojects) {
                    Object.values(node.subprojects).forEach(countBuildTypes);
                }
            }
            Object.values(projects).forEach(countBuildTypes);
            
            document.getElementById('total-builds').textContent = totalBuilds;
            document.getElementById('total-projects').textContent = projectNames.length;
            document.getElementById('total-buildtypes').textContent = totalBuildTypes;
        }
        
        // Fonction pour analyser la structure des projets
        function analyzeProjectsStructure(data) {
            const projects = data.projects || {};
            let structure = '=== STRUCTURE DES PROJETS ===\n\n';
            
            for (const [projectName, projectData] of Object.entries(projects)) {
                structure += `üìÅ ${projectName}\n`;
                
                if (projectData.builds && projectData.builds.length > 0) {
                    structure += `  üìÑ Builds √† la racine (${projectData.builds.length}):\n`;
                    projectData.builds.forEach(build => {
                        structure += `    - ${build.name} (${build.buildTypeId})\n`;
                    });
                }
                
                if (projectData.subprojects) {
                    structure += `  üìÇ Sous-projets (${Object.keys(projectData.subprojects).length}):\n`;
                    for (const [subName, subData] of Object.entries(projectData.subprojects)) {
                        structure += `    üìÅ ${subName}\n`;
                        
                        if (subData.builds && subData.builds.length > 0) {
                            structure += `      üìÑ Builds (${subData.builds.length}):\n`;
                            subData.builds.forEach(build => {
                                structure += `        - ${build.name} (${build.buildTypeId})\n`;
                            });
                        }
                        
                        if (subData.subprojects && Object.keys(subData.subprojects).length > 0) {
                            structure += `      üìÇ Sous-sous-projets (${Object.keys(subData.subprojects).length}):\n`;
                            for (const [subSubName, subSubData] of Object.entries(subData.subprojects)) {
                                structure += `        üìÅ ${subSubName}\n`;
                                if (subSubData.builds && subSubData.builds.length > 0) {
                                    structure += `          üìÑ Builds (${subSubData.builds.length}):\n`;
                                    subSubData.builds.forEach(build => {
                                        structure += `            - ${build.name} (${build.buildTypeId})\n`;
                                    });
                                }
                            }
                        }
                    }
                }
                structure += '\n';
            }
            
            return structure;
        }
        
        // Charger les donn√©es d'arborescence
        async function loadTreeData() {
            const startTime = Date.now();
            
            try {
                console.log('Chargement des donn√©es d\'arborescence...');
                const response = await fetch('/api/builds/tree');
                const responseTime = Date.now() - startTime;
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Donn√©es d\'arborescence re√ßues:', data);
                
                // Mettre √† jour les statistiques
                updateStats(data);
                document.getElementById('response-time').textContent = responseTime;
                
                // Afficher les donn√©es brutes
                document.getElementById('loading-tree').style.display = 'none';
                document.getElementById('tree-data').style.display = 'block';
                document.getElementById('tree-data').textContent = formatJSON(data);
                
                // Analyser la structure des projets
                document.getElementById('loading-projects').style.display = 'none';
                document.getElementById('projects-structure').style.display = 'block';
                document.getElementById('projects-structure').textContent = analyzeProjectsStructure(data);
                
                // Cr√©er une liste simple de tous les builds
                let allBuilds = [];
                function collectBuilds(node, path = '') {
                    if (node.builds) {
                        node.builds.forEach(build => {
                            allBuilds.push({
                                name: build.name,
                                buildTypeId: build.buildTypeId,
                                projectName: build.projectName,
                                status: build.status,
                                path: path
                            });
                        });
                    }
                    if (node.subprojects) {
                        Object.entries(node.subprojects).forEach(([name, subData]) => {
                            collectBuilds(subData, path ? `${path} > ${name}` : name);
                        });
                    }
                }
                Object.entries(data.projects || {}).forEach(([name, projectData]) => {
                    collectBuilds(projectData, name);
                });
                
                document.getElementById('loading-builds').style.display = 'none';
                document.getElementById('builds-list').style.display = 'block';
                document.getElementById('builds-list').textContent = formatJSON(allBuilds);
                
                console.log('‚úÖ Donn√©es d\'arborescence charg√©es avec succ√®s');
                
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
                document.getElementById('loading-tree').innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }
        
        // Charger les donn√©es au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page de debug charg√©e, d√©marrage du chargement des donn√©es...');
            loadTreeData();
        });
        
        // Fonction pour rafra√Æchir les donn√©es
        function refreshData() {
            console.log('Rafra√Æchissement des donn√©es...');
            document.getElementById('loading-tree').style.display = 'block';
            document.getElementById('loading-builds').style.display = 'block';
            document.getElementById('loading-projects').style.display = 'block';
            document.getElementById('tree-data').style.display = 'none';
            document.getElementById('builds-list').style.display = 'none';
            document.getElementById('projects-structure').style.display = 'none';
            loadTreeData();
        }
        
        // Ajouter un bouton de rafra√Æchissement
        const refreshButton = document.createElement('button');
        refreshButton.textContent = 'üîÑ Rafra√Æchir';
        refreshButton.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff88;
            color: #1e1e1e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        `;
        refreshButton.onclick = refreshData;
        document.body.appendChild(refreshButton);
    </script>
</body>
</html> 